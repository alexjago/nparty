name: nparty
version: "0.1.0"
author: Alex Jago
about: "N-Party-Preferred distribution of Australian Senate ballots by polling place, projection down to SA1s, aggregation to state/local districts."

settings:
    - ArgRequiredElseHelp
    - VersionlessSubcommands
args:
subcommands:
    - data:
        settings:
            - ArgRequiredElseHelp
        about: "Either download all necessary AEC data directly, or examine the URLs to the relevant files."
        after_help: "Please note that you'll also need to convert XLSX to CSV manually. At least for now..."
        args:
            - download:
                help: "download everything to specified folder"
                short: d
                long: download
                value_name: DL_FOLDER
            - examine:
                help: "write list of downloads to FILE as HTML, or pass `-` to output plain text to stdout instead."
                short: e
                long: examine
                value_name: FILE
        groups:
            - dl_or_ex:
                args:
                    - download
                    - examine

    - upgrade:
        about: "Upgrade electoral and geographic data files published in older formats to use the latest format."
        settings:
            - SubcommandRequiredElseHelp
        subcommands:
            - prefs:
                about: "upgrade a preference file to the latest format"
                args:
                    - suffix:
                        help: "suffix for when filenames would collide"
                        long: suffix
                        default_value: "_to19"
                        value_name: SUFFIX
                    - filter:
                        help: "shell-style expression to filter input filenames from directory"
                        long: filter
                        default_value: "aec-senate-formalpreferences*"
                        value_name: FILTER
                    - candidates:
                        help: "candidate CSV file"
                        value_name: CANDIDATES_FILE
                        required: true
                    - input:
                        help: "input file or directory"
                        value_name: INPUT
                        required: true
                    - output:
                        help: "output file or directory"
                        value_name: OUTPUT
                        required: true


            - sa1s:
                about: "convert an SA1s-Districts file from old SA1s to new"
                args:
                    - no_infile_headers:
                        long: no-infile-headers
                        help: Indicate lack of header row for input file
                    - corredspondencefile:
                        help: "Columns should be: 'SA1_7DIGITCODE_old', 'SA1_7DIGITCODE_new', 'RATIO'"
                        value_name: CORRESPONDENCE_FILE
                        required: true
                    - input:
                        help: "input file; columns should be 'SA1_Id', 'Dist_Name', 'Pop', 'Pop_Share'"
                        value_name: INPUT
                        required: true
                    - output:
                        help: "output file; columns will be 'SA1_Id', 'Dist_Name', 'Pop', 'Pop_Share'"
                        value_name: OUTPUT
                        required: true


    - configure:
        about: "Generate a configuration file interactively, possibly using an existing file as a basis."
        after_help: "Note: Options marked * will be asked for interactively if not specified. (Other options are helpful, but not required.)"
        settings:
             - ArgRequiredElseHelp
        args:
            - year:
                long: year
                help: "* Year of the election"
                takes_value: true
            - data_dir:
                long: data-dir
                help: "Election Data directory"
                takes_value: true
            - dist_dir:
                long: dist-dir
                help: "Geographic Data directory"
                takes_value: true
            - polling_places:
                long: polling-places
                help: "* Polling Places file"
                takes_value: true
            - sa1s_breakdown:
                long: sa1s-breakdown
                help: "* Polling Places to SA1s breakdown file"
                takes_value: true
            - output_dir:
                long: output-dir
                help: "* Output Directory"
                takes_value: true
            - from:
                long: from
                help: An existing configuration file to take defaults from
                value_name: old_config
            - party_details:
                help: "The AEC's 'Political Parties' CSV"
                long: party-details
                takes_value: true
            - candidates:
                required: true
                help: AEC candidate CSV file
                value_name: CANDS_FILE
            - configfile:
                required: true
                help: The configuration file to generate.
                value_name: NEW_CONFIG

    - list:
        about: "List scenarios from the configuration file."
        after_help: "Scenario tables are printed to standard output. If that's a terminal, they'll be pretty-printed with elastic tabstops. If that's a pipe or file, they'll be tab-separated to make further processing as straightforward as possible."
        args:
            - configfile:
                help: The configuration file to list scenarios from
                required: true

    - run:
        about: "Run scenarios from the configuration file."
        # after_help: "Note: You probably don't need to worry about [-d | -p | -c]. If you leave them out, all three phases will be performed intelligently and in order (distribution, projection, combination) for each scenario desired."
        after_help: "Note: You probably don't need to worry about [-c | -d | -p]."
        settings:
             - ArgRequiredElseHelp
        args:
            # - refresh:
            #     short: r
            #     long: refresh
            #     help: "Refresh every file created, even if it already exists and is newer than all its source files"
            - js:
                long: js
                help: "Also output JavaScript from the combination stage, for the website predictor. Ignored if [-c | -d]."
                conflicts_with:
                    - distribute
                    - project
            - distribute:
                short: d
                long: distribute
                help: Perform ONLY the party-preferred distribution phase
            - project:
                short: p
                long: project
                help: Perform ONLY the polling-places to SA1s projection phase
            - combine:
                short: c
                long: combine
                help: Perform ONLY the SA1s to districts combination phase
            # - all:
            #     short: a
            #     long: all
            #     help: Run all scenarios specified in the configuration file
            #     overrides_with: scenario
            - scenario:
                short: s
                long: scenario
                help: Run a SPECIFIC scenario from the configuration file (can be given multiple times to run several scenarios)
                multiple: true
                takes_value: true
                number_of_values: 1
            - configfile:
                help: The configuration file to run
                required: true

        groups:
            - stages:
                args:
                    - distribute
                    - project
                    - combine
